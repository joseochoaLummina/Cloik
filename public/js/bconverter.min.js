function outputInfo(e){
    document.getElementById("outputArea").innerHTML=e
}

function timeToSeconds(e){
    var t=e.split(":");
    return 60*parseFloat(t[0])*60+60*parseFloat(t[1])+parseFloat(t[2])+parseFloat("0."+t[3])
}

function audio_convert(e,t,o,n,a,s,i,p,u,c,r,l){
    var d, arguments,
        f="input."+c.split(".").pop(),
        m=/Duration: (.*?), /,
        h=/time=(.*?) /,
        w=new Worker("./js/auido_worker.js");

    switch(w.onmessage = function(e){
        var t=e.data;
        if("ready" === t.type&&window.File&&window.FileList&&window.FileReader);
        else if("stdout"==t.type)
            console.log(t.data);
        else if("stderr"==t.type){
            if(console.log(t.data),m.exec(t.data)&&(d=timeToSeconds(m.exec(t.data)[1])),h.exec(t.data)){var o=timeToSeconds(h.exec(t.data)[1]);
            ;d&&r(Math.floor(o/d*100))}
        }
        else if("done"==t.type){
            var n=t.data.code,a=Object.keys(t.data.outputFiles);
            if(0==n&&a.length>0&&t.data.outputFiles[a[0]].byteLength>0){
                var s=a[0], i=t.data.outputFiles[s];
                 l(i,s)
            }
            else 
                l(null)
        }
    },
    (arguments=[]).push("-i"),
    arguments.push(f),
    ""!=t&&(arguments.push(s),arguments.push(t)),
    ""!=o&&(arguments.push(i),arguments.push(o)),
    ""!=n&&(arguments.push(p),arguments.push(n)),
    a.toLowerCase()){
        case"mp3":arguments.push("-acodec"),arguments.push("libmp3lame"),arguments.push("output(js-audio-converter.com).mp3");
        break;
        case"ogg":arguments.push("-acodec"),""!=u?(arguments.push(u),"vorbis"==u&&(arguments.push("-strict"),arguments.push("-2"))):arguments.push("flac"),arguments.push("output(js-audio-converter.com).ogg");
        break;
        case"aac":arguments.push("-acodec"),""!=u?arguments.push(u):arguments.push("aac"),arguments.push("-f"),arguments.push("mp4"),arguments.push("output(js-audio-converter.com).aac");
        break;
        case"wma":arguments.push("-acodec"),""!=u?arguments.push(u):arguments.push("wmav1"),arguments.push("-f"),arguments.push("asf"),arguments.push("output(js-audio-converter.com).wma");
        break;
        case"wav":arguments.push("output(js-audio-converter.com).wav");
        break;
        case"m4a":arguments.push("-acodec"),""!=u?arguments.push(u):arguments.push("aac"),arguments.push("output(js-audio-converter.com).m4a");
        break;
        case"m4r":arguments.push("-acodec"),arguments.push("aac"),arguments.push("-f"),arguments.push("ipod"),arguments.push("output(js-audio-converter.com).m4r");
        break;
        case"flac":arguments.push("-acodec"),arguments.push("flac"),arguments.push("output(js-audio-converter.com).flac");
        break;
        case"opus":arguments.push("-acodec"),arguments.push("libopus"),arguments.push("output(js-audio-converter.com).opus");
        break;
        case"aiff":arguments.push("-acodec"),arguments.push("pcm_s16be"),arguments.push("output(js-audio-converter.com).aiff");
        break;
        case"mmf":arguments.push("-acodec"),arguments.push("adpcm_yamaha"),arguments.push("-strict"),arguments.push("-2"),arguments.push("output(js-audio-converter.com).mmf")
        }w.postMessage({
            type:"command",arguments:arguments,files:[{name:f,data:e}]
        })
}

function ConvertirAudio(audioMP3, audioName) {
    window.File&&window.FileReader&&window.FileList&&window.Blob||outputInfo(str_browserNotSupport);
    var t = audioMP3;
    var url;

    var t = new FileReader;
    t.onload = function (e) {
        var t = this.result;
        array = new Uint8Array(t), function(e) {
            var o = '', n = "/convertParam.htmlx1=128k&x2=44100&x3=2&x4=WAV&x5=pcm_s16le";

            if (200===200) {
                var t = ""; // t='128k,44100,2,-ab,-ar,-ac,WAV,pcm_s16le'
                
                t='128k,44100,2,-ab,-ar,-ac,WAV,pcm_s16le';
                audio_convert(e, '16k', '16000', '1', 'WAV', '-ab','-ar','-ac','pcm_s16le',audioName, 
                    function(e) {},
                    function(e,t) {
                        if (e) {
                            var o=new Blob([e]);
                            url = window.URL.createObjectURL(o);
                            console.log(url);
                            subirBlobAwsS3(o, audioName);
                        }
                    }
                );
            }
            else {
                console.log("Request failed.  Returned status of "+o.status), o
            }
        }(array)
    }, t.readAsArrayBuffer(audioMP3);
}


function subirBlobAwsS3(file, audioName) {
    if (file) {
        $("#add_language_test_modal").modal('hide');
        $("#add_language_test_thanks_modal").modal();

        var body = {
            Key: audioName,
            ContentType: file.type,
            Body: file
        };

        AWS.config.update({                    
            accessKeyId : ' AKIAQYEJSJ2ZH2ZFRBXG',
            secretAccessKey : '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'
        });

        AWS.config.region = 'us-east-2';

        var bucket = new AWS.S3(
        {
            partSize: 5 * 1024 * 1024,
            queueSize: 1,
            params: {
                Bucket: 'filescloik/audios',
            }
        });

        bucket.upload(body).on('httpUploadProgress', (evt) => {})
        .send(function(err, data) {
            if (data) {
                var urlAudio = data["Location"];
                var textAudio = $("#test-paragraph").html();
                var iso_code = document.getElementById("iso_code").value;
                var api_code = document.getElementById("api_code").value;
                var id_text = document.getElementById("id_paragraph").value;

                $.ajax({
                    type: 'POST',
                    url: 'https://cloik-262019.appspot.com/api/v1/test-idiomas',
                    dataType: 'json',
                    headers: {
                        'Authorization': 'Basic ' + btoa("tzapMZRnpm8FAcTOCyH1lYZ0raDamX1M:i3dSAXafIzycFbh9MwVxIgCasbiElLc1"),
                    },
                    data: {
                        audio: urlAudio,
                        lang: api_code,
                        text: textAudio,
                        await: true
                    },
                    success: function(data) {
                        if (data.err == false) {
                            $.ajax({
                                type: "POST",
                                url: "{{route('my.language.test')}}",
                                data: {
                                    "_token": "{{ csrf_token() }}",
                                    lang: iso_code,
                                    url: urlAudio,
                                    score: data.match,
                                    id_paragraph: id_text
                                },
                                datatype: 'json',
                                success: (json) => {
                                    $("#add_language_test_thanks_modal").html(json.html);

                                    if ((json.url).length>0) {
                                        var key = (json.url).replace("https://filescloik.s3.us-east-2.amazonaws.com/audios/", "");
                                        eliminarVideo(key);
                                    }
                                },
                                error: function(err2) {
                                    console.log('err2: ' ,err2);
                                }
                            });
                        }
                    },
                    error: function(err) {
                        console.log(err);
                    }
                });
            }

            if (err) {
                alert("Error upload");
                // $('#videoUpload').hide();
                console.log(err);
            }
        });
    }
} 